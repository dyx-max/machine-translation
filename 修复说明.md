# 模型输出问题修复说明

## 修复内容总结

根据诊断计划，已完成以下修复：

### 1. ✅ 创建纯Transformer基线版本

**文件**: `models/transformer_baseline.py`, `train_baseline.py`

- 创建了纯Transformer模型（无GCN），用于对比验证
- 如果纯Transformer正常，说明问题在GCN部分
- 使用方法：`python train_baseline.py`

### 2. ✅ 修复GCN输入问题（关键修复）

**文件**: `models/model.py`

**问题**：GCN使用初始embedding，而Transformer使用深层特征，特征空间不匹配

**修复**：
- GCN现在使用Transformer第一层的输出，而不是初始embedding
- 这样GCN和Transformer的特征空间更匹配
- 添加了权重初始化（Xavier/He初始化）

**修改位置**：
- `encode()`: GCN使用`transformer_first_out`而不是`src_emb`
- `decode()`: GCN使用`transformer_first_out`而不是`tgt_emb`
- 添加了`_init_weights()`方法

### 3. ✅ 修复Beam Search解码器

**文件**: `utils/decoder.py`

**修复内容**：
- ✅ 修复EOS处理：生成EOS后立即标记为完成，不再扩展
- ✅ 添加长度归一化（length penalty=0.6），使不同长度的beam得分可比
- ✅ 改进beam初始化逻辑
- ✅ 兼容纯Transformer基线（adj参数可选）

**关键改进**：
```python
# 使用归一化得分
normalized_score = new_score / (seq_len ** length_penalty)

# 检查是否生成EOS
is_finished = (next_token == 2)
```

### 4. ✅ 改进Tokenizer解码

**文件**: `data/tokenizer.py`

**修复内容**：
- ✅ 正确处理没有EOS的情况
- ✅ 添加长度限制，防止输出过长
- ✅ 改进错误处理（解码失败时返回空字符串）
- ✅ 支持tensor输入

### 5. ✅ 添加调试输出

**文件**: `training/validator.py`, `training/trainer.py`

**新增功能**：
- 打印logits分布统计
- 打印EOS token的概率
- 打印Top-5 token概率
- 打印GCN和Transformer的输出统计
- 打印GCN和Transformer输出的差异

**使用方法**：
```python
trainer.validate(epoch, debug=True)  # 启用调试模式
```

### 6. ✅ 添加权重初始化

**文件**: `models/model.py`, `models/transformer_baseline.py`

**初始化策略**：
- Embedding层：normal初始化（std = d_model^-0.5）
- Generator层：Xavier初始化
- 确保训练起点合理

## 使用建议

### 1. 先验证纯Transformer基线

```bash
python train_baseline.py
```

如果纯Transformer能达到80%准确率，说明问题在GCN部分，已修复的GCN输入问题应该能解决。

### 2. 训练修复后的模型

```bash
python train.py
```

### 3. 启用调试模式查看详细信息

在`trainer.py`中修改：
```python
self.validate(epoch, debug=True)  # 添加debug=True
```

## 预期效果

修复后应该能够：
1. ✅ 正确生成EOS token并停止生成
2. ✅ 输出长度与目标长度匹配（通过length penalty）
3. ✅ 输出内容更接近目标内容（通过GCN输入修复）
4. ✅ 提供详细的调试信息帮助进一步诊断

## 关键修复点

**最关键的修复**：GCN输入问题
- **之前**：GCN使用初始embedding（浅层特征）
- **现在**：GCN使用Transformer第一层输出（与Transformer特征空间匹配）
- **影响**：这应该能显著改善输出质量

## 下一步

如果修复后仍有问题：
1. 运行纯Transformer基线，确认Transformer本身是否正常
2. 启用调试模式，查看GCN和Transformer的输出统计
3. 检查邻接矩阵是否正确（是否全零或异常）
4. 检查梯度流是否正常

